# 第 7 章 链接

链接(linking)是将各种代码和数据部分收集起来并组合成为一个单一文件的过程，这个文件可被加载到存储器并执行。

- 链接可以执行于
    - 编译时(compile time)
    - 加载时(load time)
    - 运行时(run time)

> 链接器使得**分离编译**（separate compilation）成为可能，这样可以将一个程序分割成多个文件，每个文件可以独立编译。之后修改一个文件，只需重新编译这个文件，而不必重新编译所有文件。

## 7.1 编译器驱动程序

大多数编译系统提供**编译器驱动程序**，它代表用户在需要时调用语言预处理器、编译器、汇编器和链接器。

```c
// main.c
int sum(int *a, int n);

int array[2] = {1,2};

int main(){
  int val = sum(array, 2);
  return val;
}

// sum.c
int sum(int *a, int n) {
  int i, s = 0;
  for (i = 0; i < n; i++) {
    s += a[i];
  }
  return s;
}
```

![20240505221432](https://cdn.jsdelivr.net/gh/Corner430/Picture/images/20240505221432.png)

## 7.2 静态链接

静态链接器以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的、可以加载和运行的可执行目标文件作为输出。

在构造可执行文件的过程中，链接器必须要完成两个任务：
1. **符号解析**（symbol resolution）
    目标文件定义和引用符号，每个符号对应一个函数、一个全局变量或一个静态变量。符号解析的目的是将每个符号**引用**正好和一个符号**定义**关联起来。
2. **重定位**（relocation）
    编译器和汇编器生成从地址 0 开始的代码和数据节（section）。链接器通过把每个符号定义与一个内存位置关联起来，从而**重定位**这些节，然后修改所有对这些符号的引用，使得它们指向这个内存位置。

## 7.3 目标文件

目标文件有三种形式：

- **可重定位目标文件**。包含二进制代码和数据，其形式可以在编译时和其他可重定位目标文件合并起来，创建一个可执行目标文件
- **可执行目标文件**。包含二进制代码和数据，其形式可以被直接复制到内存并执行
- **共享目标文件**。一种特殊类型的可重定位目标文件，可以在加载或者运行时被动态地加载到内存并链接。

编译器和汇编器生成可重定位目标文件（包括共享目标文件），链接器生成可执行目标文件。

## 7.4 可重定位目标文件

可重定位目标文件由多个不同的节组成，每一节都是一个连续的字节序列。指令、初始化了的全局变量、未初始化的变量分别位于不同的节。

![20240505222654](https://cdn.jsdelivr.net/gh/Corner430/Picture/images/20240505222654.png)

- **ELF头**（ELF header）。以一个 16 字节的序列开始，描述了生成该文件的系统的字长和字节顺序。ELF头剩下的部分包含帮助链接器语法分析和解释目标文件的信息。

> 夹在 ELF 头和节头部表之间的都是节

- `.text`: 已编译程序的机器代码
- `.rodata`: **只读数据**，比如 `printf` 语句中的格式串和开关语句的跳转表
- `.data`: **已初始化的全局和静态 C 变量。局部 C 变量在运行时被保存在栈中**，既不在 `.data` 也不在 `.bss` 中
- `.bss`: **未初始化的全局和静态 C 变量，以及所有被初始化为 0 的全局或静态变量**。不需要占用实际的磁盘空间
- `.symtab`: 符号表，存放在程序中定义和引用的函数和全局变量的信息。
- `.rel.text`: `.text` 节中位置的列表
- `.rel.data`: 被模块引用或定义的而所有全局变量的重定位信息。
- `.debug`: 调试符号表

> 相对于`.data`, 可以将 `.bss` 看成是 “更好地节省空间（Better Save Space）” 的缩写

**示例**
```cpp
#include <iostream>

using namespace std;

int gdata1 = 10; // .data
int gdata2 = 0;  // .bss
int gdata3;      // .bss

static int gdata4 = 11; // .data
static int gdata5 = 0;  // .bss
static int gdata6;      // .bss

int main() {
  int a = 12;
  int b = 0;
  int c;

  static int e = 13; // .data
  static int f = 0;  // .bss
  static int g;      // .bss
  return 0;
}
```